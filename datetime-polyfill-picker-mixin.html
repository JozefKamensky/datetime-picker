<link rel="import" href="../input-picker-pattern/input-picker-pattern.html">
<link rel="import" href="../input-picker-pattern/input-shared-style.html">
<link rel="import" href="../input-picker-pattern/dropdown-style.html">
<link rel="import" href="../input-picker-pattern/dropdown-tip-style.html">

<script>
  /**
   * mixin to extend an element with a test for an expected input type and implement a polyfill, when wanted or needed
   *
   * @appliesMixin InputPickerPattern
   *
   * @mixinFunction
   * @polymer
   *
   * @param {Object} superClass class to extend
   * @return {Object} extended class
   */
  const DatetimePolyfillPickerMixin = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends InputPickerPattern(superClass) {  // eslint-disable-line no-undef
      /**
       * template for native input element
       * @type {string}
       */
      static get _nativeInputTemplate() {
        return `
          <input class="native" type="${this.expectedNativeInputType}" hidden$="[[!native]]" disabled$="[[disabled]]" min="[[min]]" max="[[max]]" value-as-number="{{confirmedValue::input}}" step="1">
          <div hidden$="[[!_computeAnd(withTimezone, native)]]" style="display:inline-flex;align-items:center;">
            <integer-input class="replacement" pad-length="2" always-sign step="1" value="{{_timeZoneHours}}" placeholder="+00" min="-23" max="23"></integer-input>
            <span>[[_localTimeSeparator]]</span>
            <integer-input class="replacement" pad-length="2" min="0" max="45" step="15" value="{{_timeZoneMinutes}}" placeholder="00"></integer-input>
          </div>
        `;
      }

      static get replacementInputTemplate() {
        return `
          <${this.replacementInputType} class="replacement" required="[[required]]" default="[[default]]" locale="[[locale]]" hour12=[[hour12]] clamp="[[clamp]]" datetime="{{confirmedDatetime}}" with-timezone="[[withTimezone]]" min="[[min]]" max="[[max]]"></${this.replacementInputType}>
        `;
      }

      static get expectedNativeInputType() {
        return 'datetime-local';
      }

      static get replacementInputType() {
        return 'datetime-input';
      }

      static get customStyleToInclude() {
        return `input-shared-style dropdown-style dropdown-tip-style`;
      }

      /**
       * custom style content
       * @type {string}
       */
      static get customStyleContent() {
        return `
          ${super.customStyleContent || ''}
          .replacement {
            --input-color: currentColor;
            --input-background: transparent;
          }
          #picker {
            @apply --input-picker;
            padding: 0;
          }
          #picker #buttons {
            color: var(--input-color);
            background: var(--input-background);
          }
          input {
            font-family: inherit;
            font-size: inherit;
            @apply --input-style;
          }
          input[disabled] {
            @apply --input-disabled;
          }
          input:not([disabled]):focus,
          input:not([disabled]):hover {
            @apply --input-focus;
          }
        `;
      }

      static get properties() {
        return {

          confirmedDate: {
            type: String,
            notify: true
          },

          confirmedTime: {
            type: String,
            notify: true
          },

          confirmedDatetime: {
            type: String,
            notify: true
          },

          confirmedValue: {
            type: Number,
            notify: true
          }
        };
      }

      static get observers() {
        return [
          '_confirmedDatetimeChanged(confirmedDatetime)',
          '_confirmedDateTimeChanged(confirmedDate, confirmedTime)',
          '_confirmedValueChanged(confirmedValue)',
          '_computeInvalid(required, confirmedValue)'
        ];
      }

      _computeInvalid(required) {
        this.invalid = required && isNaN(this.confirmedValue);
      }

      validate() {
        this.value = this.confirmedValue;
        return super.validate();
      }

      _computeAnd(a, b) {
        return a && b;
      }

      /**
       * key press event handler
       * @param  {[type]} e Event
       */
      _checkKeycode(e) {
        if (!e || (this._hasNative && this.native)) {
          return;
        }
        if (this.opened) {
          super._checkKeycode(e);
        } else {
          this.open();
        }
      }

      _setDate(d) {
        super._setDate(d);
        if (this.autoConfirm || (this._hasNative && this.native)) {
          this._setConfirmedValues();
        }
      }

      confirm() {
        super.confirm();
        this._setConfirmedValues();
      }

      cancel() {
        this._resetValues();
        super.cancel();
      }

      _confirmedDatetimeChanged(confirmedDatetime) {
        if (confirmedDatetime === undefined) {
          this._resetConfirmedValues();
          return; // return, if resseting, so that the picker is not itself resetted
        }
        this.datetime = confirmedDatetime;
        // asnyc setting the computed the other confirmed values
        this.setProperties({
          confirmedValue: this.value,
          confirmedDate: this.date,
          confirmedTime: this.time
        });
      }

      _confirmedDateTimeChanged(confirmedDate, confirmedTime) {
        if (confirmedDate === undefined && confirmedTime === undefined) {
          this._resetConfirmedValues();
          return; // return, if resseting, so that the picker is not itself resetted
        }

        this.setProperties({
          date: confirmedDate,
          time: confirmedTime
        });
        // asnyc setting the computed the other confirmed values
        this.setProperties({
          confirmedValue: this.value,
          confirmedDatetime: this.datetime
        });
      }

      _confirmedValueChanged(confirmedValue) {
        if (isNaN(confirmedValue)) {
          this._resetConfirmedValues();
          return; // return, if resseting, so that the picker is not itself resetted
        }

        this.value = confirmedValue;
        // asnyc setting the computed the other confirmed values
        this.setProperties({
          confirmedDatetime: this.datetime,
          confirmedDate: this.date,
          confirmedTime: this.time
        });
      }

      _setConfirmedValues() {
        this.setProperties({
          confirmedDatetime: this.datetime,
          confirmedDate: this.date,
          confirmedTime: this.time,
          confirmedValue: this.value
        })
      }

      _resetConfirmedValues() {
        this.setProperties({
          confirmedDatetime: undefined,
          confirmedDate: undefined,
          confirmedTime: undefined,
          confirmedValue: undefined
        })
      }

      _resetValues() {
        if (isNaN(this.confirmedValue)) {
          return;
        }
        this.setProperties({
          datetime: this.confirmedDatetime,
          date: this.confirmedDate,
          time: this.confirmedTime,
          value: this.confirmedValue
        })
      }
    }
  }
</script>
