<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../property-mixins/datetime-mixin.html">
<link rel="import" href="../input-picker-pattern/form-element-mixin.html">
<link rel="import" href="../input-picker-pattern/input-shared-style.html">
<link rel="import" href="../input-picker-pattern/switch-container-mixin.html">
<link rel="import" href="../number-input/integer-input.html">


<script>
  /**
   * Mixin for calendar-element
   *
   * @mixinFunction
   * @polymer
   *
   * @param {Object} superClass class to extend
   * @return {Object} extended class
   */
  const TimeElementPattern = (superClass) => class extends superClass { // eslint-disable-line no-unused-vars, no-undef

    static get styleTemplate() {
      return `
        <style include="${this.customStyleToInclude}" time>
          ${this.customStyleContent}
        </style>
      `;
    }

    static get customStyleToInclude() {
      return 'input-shared-style';
    }

    /**
     * custom style content
     * @type {string}
     */
    static get customStyleContent() {
      return `
        ${super.customStyleContent || ''}
        #timer {
          display: -ms-inline-flexbox;
          display: -webkit-inline-flex;
          display: inline-flex;
          flex-flow: row nowrap;
          align-items: center;
          background: var(--input-background);
          color: var(--input-color);
          padding: 0.25em;
          @apply --input-picker;
          @apply --time-element;
        }
        #timer .field {
          display: flex;
          flex-direction: column;
          align-items: stretch;
        }
        #timer .field integer-input {
          @apply --input-style;
          justify-content: center;
          padding: 0;
          --number-input: {
            border-color: transparent;
          };
          --number-input-focus: {
            border-color: transparent;
          };
          border-color: transparent;
        }
        #timer .field integer-input:focus-within,
        #timer .field integer-input:hover {
          @apply --input-focus;
        }
        #timer .buttons {
          display: flex;
          flex-direction: column;
          align-self: stretch;
          justify-content: space-between;
        }
        #timer .field > .switch {
          padding-top: 0.25em;
          padding-bottom: 0.25em;
        }
        #timer .field > .switch:first-of-type {
          border-bottom-left-radius: 1px;
          border-bottom-right-radius: 1px;
        }
        #timer .field > .switch:last-of-type {
          border-top-left-radius: 1px;
          border-top-right-radius: 1px;
        }
        #timer .hour12-format {
          flex-shrink: 0;
          height: unset;
          width: unset;
          font-size: 0.75em;
          padding: 0.5em 0.25em;
        }
        [hidden] * {
          display: none;
        }
      `;
    }

    static get timeTemplate() {
      return `
        <div id="timer" hidden$="[[_ifClamped(clamp, 'hour')]]">
          <div class="field" hidden$="[[partsHidden.hour]]">
            <button class="icon switch" prop="hour" step="1">${this._iconStepUpTemplate}</button>
            <integer-input id="hour" hidden$="[[hour12Format]]" min="0" max="23" pad-length="2" value="{{hour}}" placeholder="00"></integer-input>
            <integer-input hidden$="[[!hour12Format]]" min="1" max="12" pad-length="2" value="{{hour12}}" placeholder="00"></integer-input>
            <button class="icon switch" prop="hour" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <span hidden$="[[partsHidden.hour]]">[[timeSeparator]]</span>
          <div class="field" hidden$="[[partsHidden.minute]]">
            <button class="icon switch" prop="minute" step="1">${this._iconStepUpTemplate}</button>
            <integer-input pad-length="2" min="0" max="59" value="{{minute}}" placeholder="00"></integer-input>
            <button class="icon switch" prop="minute" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <span hidden$="[[partsHidden.minute]]">[[timeSeparator]]</span>
          <div class="field" hidden$="[[partsHidden.second]]">
            <button class="icon switch" prop="second" step="1">${this._iconStepUpTemplate}</button>
            <integer-input pad-length="2" min="0" max="59" value="{{second}}" placeholder="00"></integer-input>
            <button class="icon switch" prop="second" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <template is="dom-if" if="[[partsHidden.second]]">
            <span hidden$="[[partsHidden.millisecond]]">0</span>
          </template>
          <span hidden$="[[partsHidden.millisecond]]">[[decimalSeparator]]</span>
          <div class="field" hidden$="[[partsHidden.millisecond]]">
            <button class="icon switch" prop="millisecond" step="1">${this._iconStepUpTemplate}</button>
            <integer-input pad-length="3" min="0" max="999" value="{{millisecond}}" placeholder="000"></integer-input>
            <button class="icon switch" prop="millisecond" step="-1">${this._iconStepDownTemplate}</button>
          </div>
          <div hidden$="[[!withTimezone]]" style="display:inline-flex;align-items:center;">
            <div class="field">
              <button class="icon switch" prop="_timeZoneHours" step="1" once>${this._iconStepUpTemplate}</button>
              <integer-input pad-length="2" always-sign step="1" min="-23" max="23" value="{{_timeZoneHours}}" placeholder="+00"></integer-input>
              <button class="icon switch" prop="_timeZoneHours" step="-1" once>${this._iconStepDownTemplate}</button>
            </div>
            <span>[[timeSeparator]]</span>
            <div class="field">
              <button class="icon switch" prop="_timeZoneMinutes" step="15">${this._iconStepUpTemplate}</button>
              <integer-input pad-length="2" min="0" max="45" step="15" value="{{_timeZoneMinutes}}" placeholder="00"></integer-input>
              <button class="icon switch" prop="_timeZoneMinutes" step="-15">${this._iconStepDownTemplate}</button>
            </div>
          </div>
          <template is="dom-if" if="[[hour12Format]]">
            <button class="hour12-format icon" hidden$="[[!_valueIsSet]]" on-click="_switchAm">
              <div hidden$="[[!isAm]]">[[amString]]</div>
              <div hidden$="[[isAm]]">[[pmString]]</div>
            </button>
          </template>
        </div>
      `
    }

    static get properties() {
      return {

        withTimezone: {
          type: Boolean,
          value: false
        }

      }
    }

    connectedCallback() {
      super.connectedCallback();
      let d = new Date(this.value || this.default);
      if (isNaN(d)) {
        d = new Date();
        d.setSeconds(0);
        d.setMilliseconds(0);
        this._setDate(d);
      }
      this.$.hour.startAt = d.getHours();
    }

    _or(a, b) {
      return a || b;
    }

    _and(a, b) {
      return a && b;
    }

    _computeInvalid(required, value) {
      this.invalid = required && isNaN(value);
    }

    _switchAm(e) {
      e && e.stopPropagation();
      this.isAm = !this.isAm;
    }
  }
</script>

<dom-module id="time-element">
  <script>
    /**
       * `<time-element>` adds a time-input to your page using Polymer.
       *
       * If you like to connect it to an input, try it like:
       *
       *  ```html
       *     <input type="time" value="{{time::input}}" step="1">
       *
       *     <time-element time="{{time}}"></time-element>
       *  ```
       *
       * For example if you clamp on `millisecond`, you can round to `0` millisecond and hide the input. If you set `clamp="second"` the inputs for *second* and *millisecond* are hidden.
       *
       * The following custom properties and mixins are also available for styling:
       *
       * Custom property | Description | Default
       * ----------------|-------------|----------
       * `--input-color` | Text-color of the element | `#dadada`
       * `--input-background` | Text-color of the element | `#2b2b2b`
       * `--input-focus-color` | Color of the focussed or hovered inputs and icons | `#f5f5f5`
       * `--input-focus-background` | Background of the focussed or hovered inputs and icons | `--primary-color, #394FE8`
       * `--input-style` | Mixin applied to the inputs | { padding: 0.25em; border-radius: 0.25em; text-align: center; transition: background 250ms cubic-bezier(0.6, 1, 0.2, 1);}`
       * `--input-focus` | Mixin applied to the focussed or hovered inputs | { color: var(--input-focus-color); background: var(--input-focus-background); }`
       * `--input-icon` | Mixin applied to the icons | `{ border-radius: 0.25em; padding: 0.5em; height: 1em; width: 1em; background: transparent; transition: background 150ms cubic-bezier(0.6, 1, 0.2, 1); }`
       * `--input-picker` | Mixin applied to the element | `{box-shadow: 0 3px 4px 0 rgba(0, 0, 0, 0.14), 0 1px 8px 0 rgba(0, 0, 0, 0.12), 0 3px 3px -2px rgba(0, 0, 0, 0.4); border-radius: 0.25em;}`
       * `--input-selection-color` | Text-color of selected texts | `var(--input-focus-color)`
       * `--input-selection-background` | Background of selected texts | `rgba(255,255,255,0.1)`
       * `--time-element` | Mixin applied to the time-element | `{}`
       *
       * @customElement
       * @polymer
       *
       * @appliesMixin TimeElementPattern
       * @appliesMixin SwitchContainerMixin
       * @appliesMixin FormElementMixin
       * @appliesMixin DatetimeMixin
       *
       * @demo demo/time-elements.html time elements
       **/
    class TimeElement extends TimeElementPattern(SwitchContainerMixin(FormElementMixin(DatetimeMixin(Polymer.Element)))) { // eslint-disable-line no-undef

      static get is() {
        return 'time-element';
      }

      static get template() {
        return `
          ${this.styleTemplate}
          ${this.timeTemplate}
        `
      }

      _dateTimeChanged(date, time) {
        if (this.__updatingTimezoneOffset) {
          return;
        }
        if (time === undefined) {
          if (this.default !== undefined) {
            this._setDate(new Date(this.default));
          } else {
            this._resetDate();
          }
          return;
        }
        this.datetime = (date || '1970-01-01') + 'T' + (time || (this.timezone ? this.timezone.slice(1) : '00:00')) + (this.timezone || 'Z');
      }
    }
    window.customElements.define(TimeElement.is, TimeElement);
  </script>
</dom-module>
